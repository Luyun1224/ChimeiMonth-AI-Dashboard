const finalDashboardData={totalCount:60,totalExternal:21,totalInternal:39,roleKpi:{it:5,clinical:24,nonClinical:31},decisionMakerKpi:{decisionMakers:15,implementers:46},externalParticipantsList:[{group:"第一組",unit:"李俊杰診所"},{group:"第一組",unit:"德幼小兒科"},{group:"第二組",unit:"大林慈濟醫院院長室醫院發展組"},{group:"第二組",unit:"復華耳鼻喉科診所"},{group:"第三組",unit:"高雄榮民總醫院教學研究部"},{group:"第三組",unit:"晉慶眼科診所"},{group:"第三組",unit:"歐洲工商管理學院"},{group:"第四組",unit:"中山大學精準醫學所"},{group:"第四組",unit:"中山大學精準醫學所"},{group:"第四組",unit:"黃清相診所"},{group:"第五組",unit:"高雄醫學大學醫學系"},{group:"第五組",unit:"高雄醫學大學醫學系"},{group:"第五組",unit:"正信診所"},{group:"第六組(貓頭鷹)",unit:"大林慈濟醫院教學部"},{group:"第六組(貓頭鷹)",unit:"大林慈濟醫院教學部"},{group:"第六組(貓頭鷹)",unit:"三愛診所"},{group:"第六組(貓頭鷹)",unit:"國光生物科技股份有限公司"},{group:"第七組(貓頭W鷹)",unit:"成大醫院受試者保護中心"},{group:"第七組(貓頭鷹)",unit:"大林慈濟醫院教學部"},{group:"第七組(貓頭鷹)",unit:"寶建醫院護理部"},{group:"第七組(貓頭鷹)",unit:"樹德科技大學"}],groupRoleData:{labels:["第一組","第二組","第三組","第四組","第五組","第六組(貓頭鷹)","第七組(貓頭鷹)"],it:[0,1,2,0,1,1,0],clinical:[6,4,0,4,1,4,5],nonClinical:[3,4,6,4,6,4,4]},externalAnalysis:{byType:{醫院:14,學校:6,其他:1},byHospitalLevel:{醫學中心:6,診所:7,地區醫院:1}}},externalLocations={奇美醫院:{lat:23.021,lon:120.241,name:"奇美醫院",city:"台南市",type:"internal",category:"醫院"},中山大學:{lat:22.6295,lon:120.2662,name:"中山大學",city:"高雄市",type:"external",category:"學校"},成大醫院:{lat:22.9996,lon:120.2223,name:"成大醫院",city:"台南市",type:"external",category:"醫院"},大林慈濟醫院:{lat:23.5935,lon:120.4658,name:"大林慈濟醫院",city:"嘉義縣",type:"external",category:"醫院"},高雄榮民總醫院:{lat:22.6744,lon:120.3233,name:"高雄榮民總醫院",city:"高雄市",type:"external",category:"醫院"},寶建醫院:{lat:22.6808,lon:120.485,name:"寶建醫院",city:"屏東縣",type:"external",category:"醫院"},李俊杰診所:{lat:22.9934,lon:120.2127,name:"李俊杰診所",city:"台南市",type:"external",category:"診所"},三愛診所:{lat:23.0033,lon:120.2163,name:"三愛診所",city:"台南市",type:"external",category:"診所"},德幼小兒科:{lat:23.0063,lon:120.2114,name:"德幼小兒科",city:"台南市",type:"external",category:"診所"},復華耳鼻喉科診所:{lat:23.009,lon:120.2274,name:"復華耳鼻喉科診所",city:"台南市",type:"external",category:"診所"},晉慶眼科診所:{lat:23.0001,lon:120.213,name:"晉慶眼科診所",city:"台南市",type:"external",category:"診所"},正信診所:{lat:23.0232,lon:120.2241,name:"正信診所",city:"台南市",type:"external",category:"診所"},黃清相診所:{lat:23.0253,lon:120.2198,name:"黃清相診所",city:"台南市",type:"external",category:"診所"},高雄醫學大學:{lat:22.6465,lon:120.301,name:"高雄醫學大學",city:"高雄市",type:"external",category:"學校"},國光生物科技:{lat:24.2154,lon:120.6022,name:"國光生物科技",city:"台中市",type:"external",category:"其他"},樹德科技大學:{lat:22.7091,lon:120.3473,name:"樹德科技大學",city:"高雄市",type:"external",category:"學校"}};"undefined"!=typeof Chart&&"undefined"!=typeof ChartDataLabels&&(Chart.defaults.font.family="'Noto Sans TC', sans-serif",Chart.defaults.color="#1f2937",Chart.defaults.plugins.legend.position="bottom",Chart.defaults.plugins.legend.labels.padding=20,Chart.register(ChartDataLabels)),document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("kpi-total").textContent=finalDashboardData.totalCount,document.getElementById("kpi-external").textContent=finalDashboardData.totalExternal,document.getElementById("kpi-internal").textContent=finalDashboardData.totalInternal,"undefined"!=typeof L){let t=L.map("map").setView([23.1,120.3],9);L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:19}).addTo(t);let a=L.divIcon({className:"morandi-marker-icon-internal",iconSize:[20,20]}),e=L.divIcon({className:"morandi-marker-icon-external-hospital",iconSize:[20,20]}),n=L.divIcon({className:"morandi-marker-icon-external-clinic",iconSize:[20,20]}),o=L.divIcon({className:"morandi-marker-icon-external-other",iconSize:[20,20]}),l={},r={},i=0,s=finalDashboardData.totalCount,c=finalDashboardData.totalInternal,d=Object.keys(externalLocations);function p(t){for(let a of d)if(t.includes(a))return externalLocations[a];return null}finalDashboardData.externalParticipantsList.forEach(t=>{let a=p(t.unit);if(a){i++;let e=`${a.lat},${a.lon}`;l[e]||(l[e]={info:a,count:0}),l[e].count++;let n=a.city;n&&(r[n]||(r[n]={internal:0,external:0}),r[n].external++)}});let $=externalLocations["奇美醫院"],u=`${$.lat},${$.lon}`;l[u]||(l[u]={info:$,count:0}),l[u].count+=c;let y=$.city;r[y]||(r[y]={internal:0,external:0}),r[y].internal+=c,i+=c;let f=document.getElementById("map-subtitle");f.textContent=`(來源: 全體人員, N=${s}, 標記 ${i}/${s} 人)`;let g=document.getElementById("city-counts-container");g.innerHTML="";let b=Object.keys(r).sort((t,a)=>{let e=(r[t].internal||0)+(r[t].external||0),n=(r[a].internal||0)+(r[a].external||0);return n-e});for(let m of b){let x=r[m];if("台南市"===m){if(x.internal>0){let _=document.createElement("span");_.className="data-badge",_.style.backgroundColor="#003D82",_.style.color="#ffffff",_.textContent=`台南市 (院內) ${x.internal} 人`,g.appendChild(_)}if(x.external>0){let D=document.createElement("span");D.className="data-badge",D.style.backgroundColor="#FFA500",D.style.color="#1f2937",D.textContent=`台南市 (院外) ${x.external} 人`,g.appendChild(D)}}else{let h=(x.internal||0)+(x.external||0);if(h>0){let C=document.createElement("span");C.className="data-badge",C.style.backgroundColor="#FFA500",C.style.color="#1f2937",C.textContent=`${m} ${h} 人`,g.appendChild(C)}}}Object.values(l).forEach(l=>{let r=`
                <div style="font-family: 'Noto Sans TC', sans-serif;">
                    <strong style="font-size: 1.1em;">${l.info.name}</strong><br>
                    報名人數： ${l.count} 人
                </div>
            `,i;i="internal"===l.info.type?a:"醫院"===l.info.category?e:"診所"===l.info.category?n:o;let s=l.info.name;L.marker([l.info.lat,l.info.lon],{icon:i}).addTo(t).bindPopup(r).bindTooltip(s,{permanent:!0,direction:"auto",offset:[10,0],className:"location-tooltip"})})}if("undefined"!=typeof Chart){let k=document.getElementById("groupChart").getContext("2d");new Chart(k,{type:"bar",data:{labels:finalDashboardData.groupRoleData.labels,datasets:[{label:"資訊",data:finalDashboardData.groupRoleData.it,backgroundColor:"#003D82"},{label:"臨床",data:finalDashboardData.groupRoleData.clinical,backgroundColor:"#FFA500"},{label:"非臨床",data:finalDashboardData.groupRoleData.nonClinical,backgroundColor:"#708090"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{stacked:!0},y:{stacked:!0,beginAtZero:!0}},plugins:{datalabels:{formatter:t=>t>0?t:"",color:"#ffffff",font:{weight:"bold",size:14},textStrokeColor:"rgba(0,0,0,0.5)",textStrokeWidth:2},tooltip:{callbacks:{footer:function(t){let a=0;return t.forEach(function(t){a+=t.parsed.y}),"本組總計: "+a+" 人"}}}}}});let F=document.getElementById("combinedAnalysisChart").getContext("2d");new Chart(F,{type:"doughnut",data:{labels:["醫學中心 (院內)","醫學中心 (院外)","診所 (院外)","地區醫院 (院外)","學校 (院外)","其他 (院外)"],datasets:[{label:"背景分析",data:[finalDashboardData.totalInternal,finalDashboardData.externalAnalysis.byHospitalLevel.醫學中心,finalDashboardData.externalAnalysis.byHospitalLevel.診所,finalDashboardData.externalAnalysis.byHospitalLevel.地區醫院,finalDashboardData.externalAnalysis.byType.學校,finalDashboardData.externalAnalysis.byType.其他],backgroundColor:["#003D82","#FFA500","#FFB84D","#FFCC99","#FFD9B3","#FFE6CC"],borderColor:"#FFFFFF",borderWidth:4,hoverOffset:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{datalabels:{formatter(t,a){let e=a.chart.data.datasets[0],n=e.data.reduce((t,a)=>t+a,0),o=(t/n*100).toFixed(1)+"%";return o},color(t){let a=t.dataset.backgroundColor[t.dataIndex];return"#FFB84D"===a||"#FFCC99"===a?"#1f2937":"#ffffff"},font:{weight:"bold",size:14},textStrokeColor:"rgba(0,0,0,0.3)",textStrokeWidth:2},tooltip:{callbacks:{label:function(t){let a=t.label||"";if(a&&(a+=": "),null!==t.parsed){let e=t.chart.getDatasetMeta(0).total,n=t.parsed,o=(n/e*100).toFixed(1)+"%";a+=`${n} 人 (${o})`}return a}}}}}})}});
